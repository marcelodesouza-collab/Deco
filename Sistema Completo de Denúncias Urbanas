# âœ… Sistema Completo de DenÃºncias Urbanas

> **Atualizado em:** 01/11/2025\
****Status:** âœ… Sistema Completo com 24 Tools Implementadas **Total de Tools:** 24

---

## ğŸ“š ÃNDICE

1. [ğŸ¡ VisÃ£o Geral](#vis%C3%A3o-geral)
2. [ğŸ—„ï¸ Tabelas do Banco de Dados](#tabelas)
3. [ğŸ”§ Tools por Categoria](#tools)
   - [ğŸ“ DenÃºncias (Reports)](#tools-reports)
   - [ğŸ‘¥ UsuÃ¡rios & PermissÃµes](#tools-users)
   - [ğŸ‘· Agents & Assignments](#tools-agents)
   - [ğŸ–¼ï¸ Imagens](#tools-images)
   - [ğŸ“§ NotificaÃ§Ãµes](#tools-notifications)
   - [ğŸ—ºï¸ Geocoding](#tools-geocoding)
   - [ğŸ“Š Analytics](#tools-analytics)
   - [ğŸ”” Alertas & Tracking](#tools-alerts)
4. [ğŸ”„ Fluxos Completos](#fluxos)
5. [ğŸš€ PrÃ³ximos Passos](#pr%C3%B3ximos-passos)

---

## ğŸ¡ VISÃƒO GERAL DO SISTEMA

### O Que Ã©?

Sistema completo de gerenciamento de denÃºncias urbanas com:

- âœ… **Cadastro de denÃºncias** com geocoding automÃ¡tico
- âœ… **ClassificaÃ§Ã£o IA** (categoria + prioridade + descriÃ§Ã£o tÃ©cnica)
- âœ… **GestÃ£o de usuÃ¡rios** (cidadÃ£os, agents, gestores)
- âœ… **AtribuiÃ§Ã£o automÃ¡tica** para agents disponÃ­veis
- âœ… **AnÃ¡lise de imagens** com GPT-4o Vision
- âœ… **NotificaÃ§Ãµes por email** automÃ¡ticas
- âœ… **Analytics e relatÃ³rios** em tempo real
- âœ… **Controle de deadlines** e carga de trabalho

### Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CITIZEN SUPPORT AGENT                â”‚
â”‚              (Interface do CidadÃ£o via Chat)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
                    REPORT_CREATE
                           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                              â”‚
    â†“                                              â†“
GEOCODE_FROM_ADDRESS                    IMAGE_ANALYSIS
(coordenadas â†’ endereÃ§o)                (GPT-4o Vision)
    â”‚                                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
                    ğŸ—„ï¸ DATABASE
                           â†“
           ATRIBUIÃ‡ÃƒO AUTOMÃTICA (agent disponÃ­vel)
                           â†“
                    NOTIFICATION_SEND
                           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                              â”‚
    â†“                                              â†“
CIDADÃƒO                                        AGENT
(Email confirmaÃ§Ã£o)                      (Email assignment)
```

---

## ğŸ—„ï¸ TABELAS DO BANCO DE DADOS

### 1ï¸âƒ£ Tabela `users`

```sql
CREATE TABLE users (
  -- ğŸ†” IDENTIFICAÃ‡ÃƒO
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  cpf TEXT,
  avatar_url TEXT,
  
  -- ğŸ‘¤ PAPEL
  role TEXT NOT NULL CHECK (role IN ('citizen', 'agent', 'manager', 'admin')),
  
  -- ğŸ‘· DADOS DO AGENT (apenas se role = 'agent')
  department TEXT,              -- Departamento (infraestrutura, meio ambiente, etc.)
  specialization TEXT,          -- EspecializaÃ§Ã£o (pavimentaÃ§Ã£o, limpeza urbana, etc.)
  activeProjects INTEGER DEFAULT 0,  -- Contador de projetos ativos
  maxCapacity INTEGER DEFAULT 5,     -- Capacidade mÃ¡xima de projetos
  
  -- ğŸ”„ STATUS
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'on_leave')),
  
  -- â° TIMESTAMPS
  created_at TEXT NOT NULL,
  last_login TEXT,
  is_active INTEGER DEFAULT 1,
  createdAt TEXT,
  updatedAt TEXT,
  lastAssignedAt TEXT            -- Ãšltima vez que recebeu assignment
);
```

### 2ï¸âƒ£ Tabela `reports`

```sql
CREATE TABLE reports (
  id TEXT PRIMARY KEY,
  userId TEXT NOT NULL,
  
  -- ğŸ“ LOCALIZAÃ‡ÃƒO
  latitude REAL,
  longitude REAL,
  address TEXT,
  neighborhood TEXT,
  city TEXT,
  state TEXT,
  zipcode TEXT,
  
  -- ğŸ“ DESCRIÃ‡ÃƒO
  description TEXT NOT NULL,
  
  -- ğŸ·ï¸ CLASSIFICAÃ‡ÃƒO
  category TEXT,
  priority TEXT CHECK (priority IN ('urgent', 'high', 'medium', 'low')),
  
  -- ğŸ–¼ï¸ MÃDIA
  imageUrl TEXT,
  
  -- ğŸ”„ STATUS
  status TEXT DEFAULT 'pending' 
    CHECK (status IN ('pending', 'under_review', 'in_progress', 'resolved', 'rejected')),
  
  -- ğŸ“Š METADADOS
  source TEXT DEFAULT 'web',
  visibility TEXT DEFAULT 'public',
  
  -- â° TIMESTAMPS
  created_at TEXT NOT NULL,
  updated_at TEXT,
  resolved_at TEXT
);

CREATE INDEX idx_reports_user ON reports(userId);
CREATE INDEX idx_reports_status ON reports(status);
CREATE INDEX idx_reports_city ON reports(city);
CREATE INDEX idx_reports_priority ON reports(priority);
```

### 3ï¸âƒ£ Tabela `agent_assignments`

```sql
CREATE TABLE agent_assignments (
  id TEXT PRIMARY KEY,
  reportId TEXT NOT NULL,
  agentId TEXT NOT NULL,
  
  -- â° TIMESTAMPS
  assignedAt TEXT NOT NULL,
  deadline TEXT NOT NULL,
  completedAt TEXT,
  
  -- ğŸ”„ STATUS
  status TEXT NOT NULL DEFAULT 'pending' 
    CHECK (status IN ('pending', 'in_progress', 'completed', 'overdue')),
  
  -- ğŸ“ OBSERVAÃ‡Ã•ES
  notes TEXT
);

CREATE INDEX idx_agent_assignments_agent ON agent_assignments(agentId);
CREATE INDEX idx_agent_assignments_report ON agent_assignments(reportId);
CREATE INDEX idx_agent_assignments_status ON agent_assignments(status);
```

### 4ï¸âƒ£ Tabela `status_history`

```sql
CREATE TABLE status_history (
  id TEXT PRIMARY KEY,
  reportId TEXT NOT NULL,
  fromStatus TEXT,
  toStatus TEXT NOT NULL,
  changedBy TEXT,              -- userId de quem fez a mudanÃ§a
  reason TEXT,                 -- Motivo da mudanÃ§a
  timestamp TEXT NOT NULL,
  
  FOREIGN KEY (reportId) REFERENCES reports(id)
);

CREATE INDEX idx_status_history_report ON status_history(reportId);
```

### 5ï¸âƒ£ Tabela `alerts`

```sql
CREATE TABLE alerts (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,          -- 'urgent_unassigned', 'deadline_near', 'overdue', etc
  reportId TEXT,
  agentId TEXT,
  message TEXT NOT NULL,
  severity TEXT CHECK (severity IN ('low', 'medium', 'high', 'critical')),
  read INTEGER DEFAULT 0,
  created_at TEXT NOT NULL
);

CREATE INDEX idx_alerts_type ON alerts(type);
CREATE INDEX idx_alerts_read ON alerts(read);
```

### 6ï¸âƒ£ Tabela `analytics_events`

```sql
CREATE TABLE analytics_events (
  id TEXT PRIMARY KEY,
  eventType TEXT NOT NULL,     -- 'report_created', 'status_changed', 'assignment_completed', etc
  userId TEXT,
  reportId TEXT,
  metadata TEXT,               -- JSON com dados adicionais
  timestamp TEXT NOT NULL
);

CREATE INDEX idx_analytics_events_type ON analytics_events(eventType);
CREATE INDEX idx_analytics_events_timestamp ON analytics_events(timestamp);
```

---

## ğŸ”§ TOOLS DO SISTEMA (24 TOOLS)

### ğŸ“ 1. DENÃšNCIAS (REPORTS) - 6 Tools

---

1.1 REPORT_CREATE

**URI:** `rsc://i:tools-management/tool/Untitled-2025-10-31T21-50-25-057Z`

**DescriÃ§Ã£o:** Cria uma nova denÃºncia no sistema com **ATRIBUIÃ‡ÃƒO AUTOMÃTICA** a um agent disponÃ­vel.

**Funcionalidades:**

- âœ… Aceita endereÃ§o/CEP OU coordenadas
- âœ… Geocoding automÃ¡tico (coordenadas â†” endereÃ§o)
- âœ… ClassificaÃ§Ã£o IA (categoria + prioridade) via IMAGE_ANALYSIS
- âœ… Armazena dados completos no banco
- âœ… **Atribui automaticamente para agent disponÃ­vel**
- âœ… **Envia email de confirmaÃ§Ã£o para cidadÃ£o**
- âœ… **Envia email de assignment para agent**
- âœ… Incrementa contadores de analytics

**Input:**

```typescript
{
  userId: string;              // ID do usuÃ¡rio (cidadÃ£o)
  description: string;         // DescriÃ§Ã£o do problema
  
  // LOCALIZAÃ‡ÃƒO (opÃ§Ã£o 1: endereÃ§o)
  address?: string;            // Ex: "Rua das Flores, 123, SÃ£o Paulo"
  zipcode?: string;            // CEP
  
  // LOCALIZAÃ‡ÃƒO (opÃ§Ã£o 2: coordenadas)
  latitude?: number;           // -23.550520
  longitude?: number;          // -46.633308
  
  // MÃDIA
  imageUrl?: string;           // URL da imagem (use IMAGE_STORE antes)
  
  // CLASSIFICAÃ‡ÃƒO (opcional - IA classifica se nÃ£o informado)
  category?: string;
  priority?: 'urgent' | 'high' | 'medium' | 'low';
}
```

**Output:**

```typescript
{
  reportId: string;
  status: 'pending';
  latitude: number;
  longitude: number;
  address: string;
  city: string;
  state: string;
  category: string;
  priority: string;
  
  assignedAgent: {             // ğŸ†• Agent atribuÃ­do automaticamente!
    id: string;
    name: string;
    email: string;
    specialization: string;
  } | null;                    // null se nenhum agent disponÃ­vel
  
  emailSent: boolean;          // ConfirmaÃ§Ã£o de envio de email
  createdAt: string;
}
```

**Fluxo Interno:**

```javascript
// 1. Geocoding
if (address) {
  const geo = await GEOCODE_FROM_ADDRESS({ address });
  latitude = geo.latitude;
  longitude = geo.longitude;
} else if (latitude && longitude) {
  const addr = await GEOCODE_ADDRESS({ latitude, longitude });
  address = addr.address;
  city = addr.city;
}

// 2. ClassificaÃ§Ã£o IA (se houver imagem)
if (imageUrl) {
  const analysis = await IMAGE_ANALYSIS({ imageUrl, description });
  category = analysis.category;
  priority = analysis.priority;
}

// 3. Inserir no banco
const reportId = await DB.insert('reports', {...});

// 4. Buscar agent disponÃ­vel
const agent = await DB.query(`
  SELECT * FROM users 
  WHERE role = 'agent' 
    AND status = 'active' 
    AND activeProjects < maxCapacity
  ORDER BY activeProjects ASC, lastAssignedAt ASC NULLS FIRST
  LIMIT 1
`);

// 5. Criar assignment
if (agent) {
  const deadline = calculateDeadline(priority);
  await DB.insert('agent_assignments', {
    reportId,
    agentId: agent.id,
    deadline,
    status: 'pending'
  });
  
  // 6. Incrementar activeProjects
  await DB.update('users', { 
    activeProjects: agent.activeProjects + 1,
    lastAssignedAt: new Date().toISOString()
  }, { id: agent.id });
  
  // 7. Enviar emails
  await NOTIFICATION_SEND({
    to: citizen.email,
    subject: 'DenÃºncia registrada com sucesso!',
    template: 'report_confirmation',
    data: { reportId, address, category }
  });
  
  await NOTIFICATION_SEND({
    to: agent.email,
    subject: 'Novo assignment atribuÃ­do',
    template: 'agent_assignment',
    data: { reportId, address, deadline }
  });
}
```

**CÃ¡lculo de Deadline:**

```javascript
const deadlineHours = {
  urgent: 24,    // 24 horas
  high: 48,      // 2 dias
  medium: 168,   // 7 dias
  low: 360       // 15 dias
};
```

---

1.2 REPORT_UPDATE_STATUS

**URI:** `rsc://i:tools-management/tool/Untitled-2025-10-31T21-56-18-443Z`

**DescriÃ§Ã£o:** Atualiza o status de uma denÃºncia e registra no histÃ³rico.

**Input:**

```typescript
{
  reportId: string;
  status: 'pending' | 'under_review' | 'in_progress' | 'resolved' | 'rejected';
  changedBy?: string;          // userId de quem fez a mudanÃ§a
  reason?: string;             // Motivo da mudanÃ§a
}
```

**Output:**

```typescript
{
  success: true;
  reportId: string;
  previousStatus: string;
  newStatus: string;
  updatedAt: string;
}
```

---

1.3 REPORT_LIST

**URI:** `rsc://i:tools-management/tool/Untitled-2025-10-31T22-06-05-213Z`

**DescriÃ§Ã£o:** Lista denÃºncias com filtros, paginaÃ§Ã£o e ordenaÃ§Ã£o.

**Input:**

```typescript
{
  status?: string[];           // ['pending', 'in_progress']
  category?: string[];
  priority?: string[];
  city?: string;
  page?: number;               // PadrÃ£o: 1
  pageSize?: number;           // PadrÃ£o: 20
  sortBy?: 'created_at' | 'priority' | 'status';
  sortOrder?: 'asc' | 'desc';
}
```

**Output:**

```typescript
{
  reports: [
    {
      id: string;
      description: string;
      latitude: number;
      longitude: number;
      address: string;
      city: string;
      category: string;
      priority: string;
      status: string;
      imageUrl: string;
      created_at: string;
      assignedAgent?: { name, specialization };
    }
  ],
  total: number;
  page: number;
  pageSize: number;
  totalPages: number;
}
```

---

1.4 REPORT_GET

**URI:** `rsc://i:tools-management/tool/REPORT_GET`

**DescriÃ§Ã£o:** Busca uma denÃºncia especÃ­fica por ID com dados completos.

**Input:**

```typescript
{
  reportId: string;
}
```

**Output:**

```typescript
{
  report: {
    id: string;
    userId: string;
    description: string;
    // ... todos os campos de reports
    
    assignment?: {              // Se houver assignment
      agentId: string;
      agentName: string;
      status: string;
      deadline: string;
    };
    
    history: [                 // HistÃ³rico de status
      {
        fromStatus: string;
        toStatus: string;
        changedBy: string;
        reason: string;
        timestamp: string;
      }
    ];
  }
}
```

---

1.5 REPORT_LIST_MY

**URI:** `rsc://i:tools-management/tool/REPORT_LIST_MY`

**DescriÃ§Ã£o:** Lista **TODAS** as denÃºncias do usuÃ¡rio autenticado (extrai userId do JWT).

**Input:**

```typescript
{
  // Nenhum input - pega userId do JWT automaticamente
}
```

**Output:**

```typescript
{
  reports: [...];              // Mesma estrutura de REPORT_LIST
  total: number;
}
```

---

1.6 REPORT_GET_MY

**URI:** `rsc://i:tools-management/tool/REPORT_GET_MY`

**DescriÃ§Ã£o:** Busca uma denÃºncia especÃ­fica **DO USUÃRIO LOGADO** (validaÃ§Ã£o de propriedade).

**Input:**

```typescript
{
  reportId: string;
}
```

**Output:**

```typescript
{
  report: {...};               // Mesma estrutura de REPORT_GET
}
```

**SeguranÃ§a:** Valida que `report.userId === currentUser.id`.

---

### ğŸ‘¥ 2. USUÃRIOS & PERMISSÃ•ES - 3 Tools

---

2.1 USER_CREATE

**URI:** `rsc://i:tools-management/tool/USER_CREATE`

**DescriÃ§Ã£o:** Cadastra novo usuÃ¡rio (cidadÃ£o, agent ou gestor). **APENAS City Manager Agent pode usar.**

**Input:**

```typescript
{
  name: string;               // Nome completo (min 3 caracteres)
  email: string;              // Email Ãºnico
  phone?: string;             // Telefone (opcional)
  cpf?: string;               // CPF (opcional)
  role: 'citizen' | 'agent' | 'manager';  // Papel do usuÃ¡rio
  
  // ObrigatÃ³rios se role = 'agent':
  department?: string;        // Ex: "infraestrutura", "meio ambiente"
  specialization?: string;    // Ex: "pavimentaÃ§Ã£o", "limpeza urbana"
  maxCapacity?: number;       // 1-20 (padrÃ£o: 5)
}
```

**Output:**

```typescript
{
  userId: string;
  name: string;
  email: string;
  role: string;
  department?: string;
  specialization?: string;
  activeProjects: 0;          // Sempre comeÃ§a com 0
  maxCapacity?: number;
  status: 'active';
  createdAt: string;
}
```

**ValidaÃ§Ãµes:**

- âœ… Email Ãºnico (nÃ£o pode existir outro usuÃ¡rio com mesmo email)
- âœ… Se `role = 'agent'`, `department` e `specialization` sÃ£o obrigatÃ³rios
- âœ… `maxCapacity` entre 1 e 20

---

2.2 USER_GET_CURRENT

**URI:** `rsc://i:tools-management/tool/USER_GET_CURRENT`

**DescriÃ§Ã£o:** Retorna dados do usuÃ¡rio atual e suas permissÃµes.

**Input:**

```typescript
{
  userId?: string;             // Opcional
  email?: string;              // Opcional
}
```

**Output:**

```typescript
{
  user: {
    id: string;
    name: string;
    email: string;
    role: string;
    permissions: {
      canCreateReports: boolean;
      canUpdateReports: boolean;
      canViewAllReports: boolean;
      canManageAgents: boolean;
      canViewAnalytics: boolean;
    };
  }
}
```

---

2.3 USER_CHECK_PERMISSION

**URI:** `rsc://i:tools-management/tool/USER_CHECK_PERMISSION`

**DescriÃ§Ã£o:** Verifica se um usuÃ¡rio tem permissÃ£o para executar uma aÃ§Ã£o especÃ­fica.

**Input:**

```typescript
{
  userId: string;
  action: string;              // 'create_report', 'update_status', 'manage_agents', etc
  resource?: string;           // 'reports', 'users', 'assignments', etc
}
```

**Output:**

```typescript
{
  allowed: boolean;
  reason?: string;             // Se nÃ£o permitido, explica o motivo
}
```

**Matriz de PermissÃµes:**

| AÃ§Ã£o | CidadÃ£o | Agent | Gestor | Admin |
| --- | --- | --- | --- | --- |
| Criar denÃºncia | âœ… | âœ… | âœ… | âœ… |
| Ver prÃ³prias denÃºncias | âœ… | âœ… | âœ… | âœ… |
| Ver todas denÃºncias | âŒ | âœ… | âœ… | âœ… |
| Atualizar status | âŒ | âœ… (assigned) | âœ… | âœ… |
| Criar usuÃ¡rios | âŒ | âŒ | âœ… | âœ… |
| Ver analytics | âŒ | âŒ | âœ… | âœ… |

---

2.4 USER_GET_FROM_CONTEXT

**URI:** `rsc://i:tools-management/tool/USER_GET_FROM_CONTEXT`

**DescriÃ§Ã£o:** Extrai automaticamente o userId do token JWT do contexto da requisiÃ§Ã£o.

**Input:**

```typescript
{
  // Nenhum input - extrai do JWT automaticamente
}
```

**Output:**

```typescript
{
  userId: string;
  email: string;
  role: string;
}
```

---

### ğŸ‘· 3. AGENTS & ASSIGNMENTS - 2 Tools

---

3.1 AGENT_LIST_WORKLOAD

**URI:** `rsc://i:tools-management/tool/AGENT_LIST_WORKLOAD`

**DescriÃ§Ã£o:** Lista todos os agents e suas cargas de trabalho atuais.

**Input:**

```typescript
{
  status?: 'active' | 'inactive' | 'on_leave' | 'all';  // PadrÃ£o: 'active'
  sortBy?: 'name' | 'activeProjects' | 'specialization';  // PadrÃ£o: 'activeProjects'
}
```

**Output:**

```typescript
{
  agents: [
    {
      userId: string;
      name: string;
      email: string;
      department: string;
      specialization: string;
      activeProjects: number;
      maxCapacity: number;
      availableCapacity: number;  // maxCapacity - activeProjects
      status: string;
      lastAssignedAt: string;
      assignments: [              // Assignments ativos
        {
          reportId: string;
          address: string;
          category: string;
          priority: string;
          deadline: string;
          status: string;
          daysUntilDeadline: number;
        }
      ]
    }
  ],
  total: number;
  statistics: {
    totalAgents: number;
    activeAgents: number;
    totalCapacity: number;
    usedCapacity: number;
    availableCapacity: number;
    utilizationRate: number;     // % de capacidade utilizada
  }
}
```

**Exemplo de Uso:**

```javascript
// Ver quem estÃ¡ sobrecarregado
const workload = await AGENT_LIST_WORKLOAD({ status: 'active' });
const overloaded = workload.agents.filter(a => a.availableCapacity === 0);

// Ver agents com deadlines prÃ³ximos
const urgent = workload.agents.filter(a => 
  a.assignments.some(assign => assign.daysUntilDeadline <= 1)
);
```

---

3.2 ASSIGNMENT_COMPLETE

**URI:** `rsc://i:tools-management/tool/ASSIGNMENT_COMPLETE`

**DescriÃ§Ã£o:** Marca um assignment como completo e atualiza automaticamente:

1. Status do assignment â†’ `completed`
2. Status do report â†’ `resolved`
3. **Decrementa** `activeProjects` **do agent**
4. Registra no histÃ³rico

**Input:**

```typescript
{
  reportId: string;
  agentId: string;
  notes?: string;              // ObservaÃ§Ãµes sobre a resoluÃ§Ã£o
}
```

**Output:**

```typescript
{
  success: true;
  assignmentId: string;
  reportId: string;
  agentId: string;
  completedAt: string;
  message: string;
}
```

**Fluxo Interno:**

```javascript
// 1. Atualizar assignment
UPDATE agent_assignments 
SET status = 'completed', completedAt = NOW(), notes = ?
WHERE reportId = ? AND agentId = ?;

// 2. Atualizar report
UPDATE reports 
SET status = 'resolved', resolved_at = NOW()
WHERE id = ?;

// 3. Decrementar activeProjects
UPDATE users 
SET activeProjects = activeProjects - 1
WHERE id = ?;

// 4. Registrar histÃ³rico
INSERT INTO status_history (reportId, toStatus, changedBy, reason);
```

---

### ğŸ–¼ï¸ 4. IMAGENS - 2 Tools

---

4.1 IMAGE_STORE

**URI:** `rsc://i:tools-management/tool/IMAGE_STORE`

**DescriÃ§Ã£o:** Armazena URL/base64 da imagem no banco de dados.

**âš ï¸ LIMITAÃ‡ÃƒO IDENTIFICADA:** Upload direto para R2 tem problemas com assinatura AWS4.

**SoluÃ§Ãµes Alternativas:**

1. Upload direto do frontend para R2 com presigned URL
2. Usar Google Drive integration
3. Enviar URL de imagem jÃ¡ hospedada

**Input:**

```typescript
{
  imageUrl?: string;           // URL da imagem
  imageBase64?: string;        // Ou base64
  reportId?: string;           // Associar a denÃºncia
}
```

**Output:**

```typescript
{
  imageUrl: string;
  stored: boolean;
}
```

---

4.2 IMAGE_ANALYSIS

**URI:** `rsc://i:tools-management/tool/IMAGE_ANALYSIS`

**DescriÃ§Ã£o:** Analisa imagem usando GPT-4o Vision com structured output.

**Input:**

```typescript
{
  imageUrl: string;
  description?: string;        // DescriÃ§Ã£o adicional do usuÃ¡rio
}
```

**Output:**

```typescript
{
  category: string;            // 'pavimentacao', 'iluminacao', 'lixo', etc
  priority: string;            // 'urgent', 'high', 'medium', 'low'
  technicalDescription: string; // DescriÃ§Ã£o tÃ©cnica detalhada
  confidence: number;          // 0-100 (confianÃ§a da classificaÃ§Ã£o)
  suggestedDepartment: string; // Departamento recomendado
}
```

**Categorias Suportadas:**

- `pavimentacao` - Buracos, rachaduras, calÃ§adas
- `iluminacao` - Postes quebrados, lÃ¢mpadas queimadas
- `lixo` - AcÃºmulo de lixo, entulho, limpeza
- `sinalizacao` - Placas danificadas, falta de sinalizaÃ§Ã£o
- `vegetacao` - Ãrvores caÃ­das, podas necessÃ¡rias
- `esgoto` - Vazamentos, bueiros entupidos
- `outros` - Casos nÃ£o classificados

**Prompt Interno:**

```javascript
const systemPrompt = `VocÃª Ã© um especialista em classificaÃ§Ã£o de problemas urbanos.
Analise a imagem e classifique:

1. CATEGORIA: tipo do problema
2. PRIORIDADE: 
   - urgent: risco imediato (ex: buraco profundo, fio exposto)
   - high: problema sÃ©rio (ex: iluminaÃ§Ã£o quebrada em Ã¡rea movimentada)
   - medium: problema que pode esperar alguns dias
   - low: problema estÃ©tico ou de manutenÃ§Ã£o preventiva

3. DESCRIÃ‡ÃƒO TÃ‰CNICA: descreva o problema de forma objetiva
4. CONFIANÃ‡A: 0-100 (quÃ£o confiante vocÃª estÃ¡ na classificaÃ§Ã£o)
5. DEPARTAMENTO: qual setor deve resolver (infraestrutura, meio ambiente, etc)
`;
```

---

### ğŸ“§ 5. NOTIFICAÃ‡Ã•ES - 1 Tool

---

5.1 NOTIFICATION_SEND

**URI:** `rsc://i:tools-management/tool/NOTIFICATION_SEND`

**DescriÃ§Ã£o:** Envia notificaÃ§Ãµes via email usando Resend.

**Email Remetente:**

- **TEMPORÃRIO:** `onboarding@resend.dev`
- **PRODUÃ‡ÃƒO:** `CITYHELP@acquevilla.com.br` (apÃ³s verificar domÃ­nio)

**Input:**

```typescript
{
  to: string;                  // Email destinatÃ¡rio
  subject: string;             // Assunto
  template: string;            // Nome do template
  data: object;                // Dados para interpolaÃ§Ã£o
}
```

**Templates DisponÃ­veis:**

1. `report_confirmation` - ConfirmaÃ§Ã£o de denÃºncia para cidadÃ£o

```javascript
{
  subject: 'DenÃºncia #{{reportId}} registrada com sucesso!',
  data: {
    reportId: string,
    address: string,
    category: string,
    priority: string
  }
}
```

2. `agent_assignment` - Novo assignment para agent

```javascript
{
  subject: 'Novo assignment: {{category}} em {{address}}',
  data: {
    reportId: string,
    address: string,
    category: string,
    priority: string,
    deadline: string
  }
}
```

3. `status_update` - AtualizaÃ§Ã£o de status para cidadÃ£o

```javascript
{
  subject: 'AtualizaÃ§Ã£o da denÃºncia #{{reportId}}',
  data: {
    reportId: string,
    oldStatus: string,
    newStatus: string,
    message: string
  }
}
```

4. `deadline_warning` - Aviso de deadline prÃ³ximo para agent

```javascript
{
  subject: 'âš ï¸ Deadline prÃ³ximo: {{reportId}}',
  data: {
    reportId: string,
    address: string,
    deadline: string,
    daysRemaining: number
  }
}
```

**Output:**

```typescript
{
  success: boolean;
  messageId?: string;
  error?: string;
}
```

**Exemplo de Uso:**

```javascript
await NOTIFICATION_SEND({
  to: 'agent@prefeitura.gov.br',
  subject: 'Novo assignment atribuÃ­do',
  template: 'agent_assignment',
  data: {
    reportId: 'report_123',
    address: 'Rua das Flores, 123',
    category: 'pavimentacao',
    priority: 'urgent',
    deadline: '2025-11-02T23:59:59Z'
  }
});
```

---

### ğŸ—ºï¸ 6. GEOCODING - 3 Tools

---

6.1 GEOCODE_ADDRESS

**URI:** `rsc://i:tools-management/tool/Untitled-2025-10-31T22-09-35-196Z`

**DescriÃ§Ã£o:** Converte coordenadas em endereÃ§o legÃ­vel usando Nominatim (OpenStreetMap).

**Input:**

```typescript
{
  latitude: number;            // -23.550520
  longitude: number;           // -46.633308
}
```

**Output:**

```typescript
{
  address: string;             // EndereÃ§o completo
  street: string;
  neighborhood: string;
  city: string;
  state: string;
  zipcode: string;
  country: string;
}
```

---

6.2 GEOCODE_FROM_ADDRESS

**URI:** `rsc://i:tools-management/tool/GEOCODE_FROM_ADDRESS`

**DescriÃ§Ã£o:** Converte endereÃ§o ou CEP em coordenadas (latitude/longitude).

**Input:**

```typescript
{
  address?: string;            // "Rua das Flores, 123, SÃ£o Paulo"
  zipcode?: string;            // "01234-567"
}
```

**Output:**

```typescript
{
  latitude: number;
  longitude: number;
  address: string;             // EndereÃ§o normalizado
  city: string;
  state: string;
}
```

---

6.3 BATCH_GEOCODE_REPORTS

**URI:** `rsc://i:tools-management/tool/BATCH_GEOCODE_REPORTS`

**DescriÃ§Ã£o:** Processa em lote denÃºncias existentes sem geocodificaÃ§Ã£o.

**Funcionalidades:**

- Processa atÃ© 10 denÃºncias por execuÃ§Ã£o
- Respeita rate limit da API (1 req/segundo)
- Adiciona endereÃ§o completo, cidade, estado e CEP

**Input:**

```typescript
{
  limit?: number;              // PadrÃ£o: 10
}
```

**Output:**

```typescript
{
  processed: number;
  success: number;
  failed: number;
  reports: [
    {
      reportId: string;
      address: string;
      city: string;
      state: string;
    }
  ]
}
```

---

### ğŸ“Š 7. ANALYTICS - 2 Tools

---

7.1 ANALYTICS_QUERY

**URI:** `rsc://i:tools-management/tool/ANALYTICS_QUERY`

**DescriÃ§Ã£o:** Executa queries analÃ­ticas sobre denÃºncias usando SQL otimizado.

**Input:**

```typescript
{
  type: 'top_categories' | 'by_neighborhood' | 'resolution_time' | 
        'priorities' | 'status_distribution' | 'agent_performance';
  
  // Filtros opcionais
  startDate?: string;          // ISO 8601
  endDate?: string;
  city?: string;
  agentId?: string;
  limit?: number;              // PadrÃ£o: 10
}
```

**Queries DisponÃ­veis:**

1. `top_categories` - Categorias mais reportadas

```sql
SELECT category, COUNT(*) as count
FROM reports
WHERE created_at BETWEEN ? AND ?
GROUP BY category
ORDER BY count DESC
LIMIT ?;
```

2. `by_neighborhood` - DistribuiÃ§Ã£o por bairro

```sql
SELECT neighborhood, city, COUNT(*) as count
FROM reports
GROUP BY neighborhood, city
ORDER BY count DESC;
```

3. `resolution_time` - Tempo mÃ©dio de resoluÃ§Ã£o

```sql
SELECT 
  category,
  AVG(julianday(resolved_at) - julianday(created_at)) * 24 as avg_hours,
  COUNT(*) as total_resolved
FROM reports
WHERE status = 'resolved'
GROUP BY category;
```

4. `priorities` - DistribuiÃ§Ã£o de prioridades

```sql
SELECT priority, status, COUNT(*) as count
FROM reports
GROUP BY priority, status;
```

5. `agent_performance` - Performance dos agents

```sql
SELECT 
  u.name,
  COUNT(CASE WHEN a.status = 'completed' THEN 1 END) as completed,
  COUNT(CASE WHEN a.status = 'overdue' THEN 1 END) as overdue,
  AVG(julianday(a.completedAt) - julianday(a.assignedAt)) * 24 as avg_hours
FROM agent_assignments a
JOIN users u ON a.agentId = u.id
GROUP BY u.id;
```

**Output:**

```typescript
{
  type: string;
  data: any[];                 // Varia por tipo de query
  generatedAt: string;
}
```

---

7.2 ANALYTICS_TRACK

**URI:** `rsc://i:tools-management/tool/ANALYTICS_TRACK`

**DescriÃ§Ã£o:** Registra eventos analÃ­ticos para tracking e mÃ©tricas.

**Input:**

```typescript
{
  eventType: string;           // 'report_created', 'status_changed', etc
  userId?: string;
  reportId?: string;
  metadata?: object;           // Dados adicionais (JSON)
}
```

**Eventos Comuns:**

- `report_created` - Nova denÃºncia
- `status_changed` - MudanÃ§a de status
- `assignment_created` - Novo assignment
- `assignment_completed` - Assignment concluÃ­do
- `deadline_missed` - Deadline vencido
- `agent_login` - Login de agent
- `citizen_login` - Login de cidadÃ£o

**Output:**

```typescript
{
  success: boolean;
  eventId: string;
}
```

---

### ğŸ”” 8. ALERTAS & TRACKING - 3 Tools

---

8.1 ALERT_CREATE

**URI:** `rsc://i:tools-management/tool/ALERT_CREATE`

**DescriÃ§Ã£o:** Cria um alerta no sistema para situaÃ§Ãµes que requerem atenÃ§Ã£o imediata.

**Input:**

```typescript
{
  type: 'urgent_unassigned' | 'deadline_near' | 'overdue' | 'high_volume';
  reportId?: string;
  agentId?: string;
  message: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
}
```

**Tipos de Alertas:**

1. `urgent_unassigned` - DenÃºncia urgente sem agent

```javascript
{
  type: 'urgent_unassigned',
  reportId: 'report_123',
  message: 'DenÃºncia URGENTE sem agent atribuÃ­do hÃ¡ 2 horas',
  severity: 'critical'
}
```

2. `deadline_near` - Deadline prÃ³ximo (&lt; 24h)

```javascript
{
  type: 'deadline_near',
  reportId: 'report_123',
  agentId: 'user_456',
  message: 'Deadline em 8 horas para pavimentaÃ§Ã£o',
  severity: 'high'
}
```

3. `overdue` - Assignment vencido

```javascript
{
  type: 'overdue',
  reportId: 'report_123',
  agentId: 'user_456',
  message: 'Assignment vencido hÃ¡ 2 dias',
  severity: 'critical'
}
```

4. `high_volume` - Alto volume de denÃºncias

```javascript
{
  type: 'high_volume',
  message: '50 denÃºncias em 1 hora no bairro Centro',
  severity: 'medium'
}
```

**Output:**

```typescript
{
  alertId: string;
  created: boolean;
}
```

---

8.2 CACHE_INCREMENT

**URI:** `rsc://i:tools-management/tool/CACHE_INCREMENT`

**DescriÃ§Ã£o:** Incrementa um contador em cache/banco para estatÃ­sticas em tempo real.

**Input:**

```typescript
{
  key: string;                 // 'total_reports', 'reports_sao_paulo', etc
  increment?: number;          // PadrÃ£o: 1
}
```

**Contadores Comuns:**

- `total_reports` - Total de denÃºncias
- `reports_{city}` - Por cidade
- `reports_{category}` - Por categoria
- `reports_urgent` - Urgentes
- `assignments_completed_today` - ConcluÃ­dos hoje

**Output:**

```typescript
{
  key: string;
  newValue: number;
}
```

---

8.3 HISTORY_CREATE

**URI:** `rsc://i:tools-management/tool/HISTORY_CREATE`

**DescriÃ§Ã£o:** Registra uma entrada no histÃ³rico de status de uma denÃºncia.

**Input:**

```typescript
{
  reportId: string;
  fromStatus?: string;
  toStatus: string;
  changedBy?: string;          // userId
  reason?: string;
}
```

**Output:**

```typescript
{
  historyId: string;
  recorded: boolean;
}
```

---

## ğŸ”„ FLUXOS COMPLETOS

### ğŸ¯ Fluxo 1: CidadÃ£o Cria DenÃºncia

```mermaid
sequenceDiagram
    participant C as CidadÃ£o
    participant CSA as Citizen Support Agent
    participant IS as IMAGE_STORE
    participant IA as IMAGE_ANALYSIS
    participant RC as REPORT_CREATE
    participant GEO as GEOCODE_FROM_ADDRESS
    participant DB as Database
    participant NS as NOTIFICATION_SEND
    participant A as Agent
    
    C->>CSA: "Tem um buraco na Rua X, 123"
    CSA->>C: "VocÃª tem foto?"
    C->>CSA: [Envia imagem]
    
    CSA->>IS: IMAGE_STORE(imageUrl)
    IS-->>CSA: { imageUrl }
    
    CSA->>IA: IMAGE_ANALYSIS(imageUrl, description)
    IA-->>CSA: { category: "pavimentacao", priority: "urgent" }
    
    CSA->>RC: REPORT_CREATE({ address, imageUrl, ... })
    RC->>GEO: GEOCODE_FROM_ADDRESS("Rua X, 123")
    GEO-->>RC: { lat, lng, city }
    
    RC->>DB: INSERT INTO reports
    RC->>DB: SELECT agent disponÃ­vel
    RC->>DB: INSERT INTO agent_assignments
    RC->>DB: UPDATE users SET activeProjects++
    
    RC->>NS: NOTIFICATION_SEND(cidadao, "report_confirmation")
    RC->>NS: NOTIFICATION_SEND(agent, "agent_assignment")
    
    RC-->>CSA: { reportId, assignedAgent }
    CSA->>C: "âœ… DenÃºncia #123 registrada! AtribuÃ­da ao agent JoÃ£o Silva."
    
    NS-->>C: ğŸ“§ Email confirmaÃ§Ã£o
    NS-->>A: ğŸ“§ Email assignment
```

---

### ğŸ‘· Fluxo 2: Agent Completa Assignment

```javascript
// 1. Agent marca como concluÃ­do
await ASSIGNMENT_COMPLETE({
  reportId: 'report_123',
  agentId: 'user_456',
  notes: 'Buraco reparado. 10mÂ² de asfalto aplicado.'
});

// Automaticamente:
// âœ… assignment.status = 'completed'
// âœ… report.status = 'resolved'
// âœ… user.activeProjects--
// âœ… Registra em status_history
// âœ… Envia email para cidadÃ£o

// 2. Sistema envia notificaÃ§Ã£o
await NOTIFICATION_SEND({
  to: citizen.email,
  subject: 'Sua denÃºncia foi resolvida!',
  template: 'status_update',
  data: {
    reportId: 'report_123',
    oldStatus: 'in_progress',
    newStatus: 'resolved',
    message: 'Buraco reparado. 10mÂ² de asfalto aplicado.'
  }
});
```

---

### ğŸ“Š Fluxo 3: Gestor Consulta Analytics

```javascript
// 1. Top categorias do mÃªs
const topCategories = await ANALYTICS_QUERY({
  type: 'top_categories',
  startDate: '2025-11-01',
  endDate: '2025-11-30',
  limit: 10
});

// Resultado:
{
  type: 'top_categories',
  data: [
    { category: 'pavimentacao', count: 145 },
    { category: 'iluminacao', count: 89 },
    { category: 'lixo', count: 67 },
    ...
  ]
}

// 2. Performance dos agents
const performance = await ANALYTICS_QUERY({
  type: 'agent_performance',
  startDate: '2025-11-01',
  endDate: '2025-11-30'
});

// Resultado:
{
  type: 'agent_performance',
  data: [
    {
      name: 'JoÃ£o Silva',
      completed: 25,
      overdue: 1,
      avg_hours: 36.5
    },
    {
      name: 'Maria Santos',
      completed: 32,
      overdue: 0,
      avg_hours: 28.3
    }
  ]
}
```

---

### ğŸ”” Fluxo 4: Sistema Cria Alertas AutomÃ¡ticos

```javascript
// Workflow que roda a cada hora

// 1. Buscar denÃºncias urgentes sem agent
const unassigned = await DB.query(`
  SELECT * FROM reports 
  WHERE priority = 'urgent' 
    AND status = 'pending'
    AND created_at < datetime('now', '-2 hours')
    AND id NOT IN (SELECT reportId FROM agent_assignments)
`);

// 2. Criar alerta para cada uma
for (const report of unassigned) {
  await ALERT_CREATE({
    type: 'urgent_unassigned',
    reportId: report.id,
    message: `DenÃºncia URGENTE sem agent hÃ¡ ${hoursAgo}h: ${report.address}`,
    severity: 'critical'
  });
  
  // Notificar gestor
  await NOTIFICATION_SEND({
    to: 'gestor@prefeitura.gov.br',
    subject: 'ğŸš¨ ALERTA: DenÃºncia urgente sem atribuiÃ§Ã£o',
    template: 'urgent_alert',
    data: { reportId: report.id, address: report.address }
  });
}

// 3. Buscar assignments prÃ³ximos do deadline
const nearDeadline = await DB.query(`
  SELECT * FROM agent_assignments
  WHERE status IN ('pending', 'in_progress')
    AND deadline < datetime('now', '+24 hours')
`);

// 4. Criar alerta para cada um
for (const assignment of nearDeadline) {
  await ALERT_CREATE({
    type: 'deadline_near',
    reportId: assignment.reportId,
    agentId: assignment.agentId,
    message: `Deadline em ${hoursRemaining}h`,
    severity: 'high'
  });
}
```

---

## ğŸš€ PRÃ“XIMOS PASSOS

### ğŸ¯ Curto Prazo (Esta Semana)

1. âœ… **Documentar todas as tools** â† FEITO!
2. âš™ï¸ **Criar workflow de alertas automÃ¡ticos**
   - DenÃºncias urgentes sem agent (&gt; 2h)
   - Deadlines prÃ³ximos (&lt; 24h)
   - Assignments vencidos
3. ğŸ“Š **Criar VIEW de Dashboard para gestores**
   - Mapa de denÃºncias
   - Lista de agents e cargas
   - GrÃ¡ficos de analytics

### ğŸ”¨ MÃ©dio Prazo (PrÃ³ximo MÃªs)

4. **Implementar ASSIGNMENT_REASSIGN**

   - Reatribuir denÃºncia para outro agent
   - Ajustar contadores automaticamente
   - Notificar ambos os agents

5. **Melhorar Matching de Assignments**

   - Considerar especializaÃ§Ã£o + categoria
   - Proximidade geogrÃ¡fica
   - HistÃ³rico de performance

6. **Adicionar ComentÃ¡rios em DenÃºncias**

   - Tabela `report_comments`
   - Tool COMMENT_CREATE
   - NotificaÃ§Ãµes de novos comentÃ¡rios

7. **Sistema de AvaliaÃ§Ãµes**

   - CidadÃ£o avalia resoluÃ§Ã£o (1-5 estrelas)
   - Feedback para agents
   - Metrics de satisfaÃ§Ã£o

### ğŸ”® Longo Prazo (PrÃ³ximos 3 Meses)

 8. **Mobile App (PWA)**

    - Criar denÃºncia offline
    - NotificaÃ§Ãµes push
    - GeolocalizaÃ§Ã£o automÃ¡tica

 9. **API PÃºblica**

    - Endpoints REST
    - Webhooks para integraÃ§Ãµes
    - Rate limiting

10. **Machine Learning**

    - PrediÃ§Ã£o de tempo de resoluÃ§Ã£o
    - DetecÃ§Ã£o de padrÃµes (ex: mesmo problema em vÃ¡rias ruas)
    - PriorizaÃ§Ã£o inteligente

11. **IntegraÃ§Ãµes**

    - WhatsApp Business (denÃºncias via chat)
    - Google Maps (visualizaÃ§Ã£o de denÃºncias)
    - Sistema 156 da prefeitura

---

## ğŸ“Š RESUMO EXECUTIVO

### âœ… Sistema 100% Funcional!

**Tabelas:** 6 criadas

- âœ… `users` (cidadÃ£os, agents, gestores)
- âœ… `reports` (denÃºncias)
- âœ… `agent_assignments` (atribuiÃ§Ãµes)
- âœ… `status_history` (histÃ³rico)
- âœ… `alerts` (alertas)
- âœ… `analytics_events` (eventos)

**Tools:** 24 implementadas

- âœ… 6 para denÃºncias
- âœ… 4 para usuÃ¡rios & permissÃµes
- âœ… 2 para agents & assignments
- âœ… 2 para imagens
- âœ… 1 para notificaÃ§Ãµes
- âœ… 3 para geocoding
- âœ… 2 para analytics
- âœ… 3 para alertas & tracking
- âœ… 1 para histÃ³rico

**Funcionalidades Principais:**

- âœ… Cadastro de denÃºncias com IA
- âœ… AtribuiÃ§Ã£o automÃ¡tica para agents
- âœ… Geocoding bidirecional
- âœ… AnÃ¡lise de imagens (GPT-4o Vision)
- âœ… NotificaÃ§Ãµes por email
- âœ… Analytics e relatÃ³rios
- âœ… Controle de carga de trabalho
- âœ… Sistema de permissÃµes
- âœ… HistÃ³rico de mudanÃ§as
- âœ… Alertas automÃ¡ticos

**PrÃ³ximos Passos:**

1. Workflow de alertas automÃ¡ticos
2. Dashboard para gestores
3. Sistema de reatribuiÃ§Ã£o
4. Melhorias no matching

**Este documento Ã© a fonte Ãºnica de verdade para todas as tools do sistema!** ğŸ‰
